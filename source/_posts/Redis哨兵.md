---
title: Redis哨兵
categories:
  - Redis
tags:
  - Redis
date: 2019-03-11 13:45:55
---

Redis 主从复制是高可用的基础，但仅仅只有复制功能还远远达不到高可用，而 Redis 哨兵正是为了解决高可用而生。<!-- more -->

## Redis 主从复制的问题

Redis 主从复制的作用主要有两个：

- 当主节点故障时，从节点成为新的主节点继续对外服务
- 从节点分摊主节点的读流量

但是主从复制也带来了以下问题：

- 主节点故障时，需要手动将从节点升级为主节点，并通知业务方修改主节点地址

可以看出主从复制模式下，一旦主节点出现故障，需要人工干预进行故障转移，这显然不能满足高可用的需求。

## Redis Sentinel

Redis Sentinel 正是为了解决 Redis 主从复制高可用而生的，当主节点出现故障时，Redis Sentinel 能够自动完成故障发现和故障转移，并通知应用方，从而实现高可用。

### 拓扑结构

Redis Sentinel 是一个分布式架构，其中包括多个 Sentinel 节点和多个数据节点，其基本结构如下图所示。

![](sentinel.png)

- 每个 Sentinel 节点会对数据节点和其他 Sentinel 节点进行监控
- 当 Sentinel 发现某个数据节点不可达时，会对节点做下线标识
- 如果被标识的节点是主节点，Sentinel 还会和其他 Sentinel 节点进行协商，当大部分 Sentinel 节点认为主节点不可达时，会选举出一个 Sentinel 节点进行故障转移，同时会将这个变化通知给客户端。


#### 故障转移过程

下面我们来看下故障转移的整个过程：

1. 主节点故障，从节点与主节点失去连接，主从复制失败。
2. Sentinel 节点通过定期检查发现主节点故障。
3. 多个 Sentinel 节点对主节点故障达成一致，并选举出一个 Sentinel 领导者节点负责故障转移。
4. Sentinel 领导者节点在从节点中自动选择一个最优的从节点切换为主节点，其他从节点重新从新的主节点进行复制。
5. 旧的主节点恢复后，重新加入，成为新的主节点的从节点。


### 实现原理

#### 三个定时任务

- 每隔10秒，每个 Sentinel 节点会向所有的数据节点发送 info 命令获取最新的拓扑结构。
  - 通过向主节点发送 info 命令来获取从节点信息。
  - 当有新的从节点加入时可以立即获得感知。
  - 节点不可达或故障转移后，可以更新节点拓扑信息。

- 每隔2秒，每个 Sentinel 节点会向所有数据节点的 ```_sentinel_:hello```频道上发送该 Sentinel 节点关于主节点的判断以及当前 Sentinel 节点的信息。同时每个 Sentinel 节点也会订阅该频道来获取其他 Sentinel 节点的信息和对主节点的判断。
  -  了解其他 Sentinel 节点的信息，如果有新加入的 Sentinel 节点，则将该 Sentinel 节点的信息保存下来，并与之建立连接。
  -  Sentinel 节点交换对主节点的判断，作为客观下线和领导者选举的依据。

- 每隔1秒，每个 Sentinel 节点会向所有的数据节点和其他 Sentinel 节点发送 ping 命令做心跳检查，来确定其他节点是否可达。

#### 主观下线

每隔1秒，Sentinel 节点会向其他节点做心跳检查，当这些节点超过 down-after-milliseconds 没有回复，Sentinel 节点就会对该节点做失败判定，这个行为叫主观下线。

#### 客观下线

当主观下线的节点是主节点时，该 Sentinel 节点会向其他 Sentinel 节点询问对主节点的判断，当大部分 Sentinel 节点认为主节点故障时，该 Sentinel 节点会做客观下线的决定。

#### 领导者 Sentinel 节点选举

当对主节点做出客观下线后，所有的 Sentinel 节点需要选举出一个领导者节点完成故障转移的工作，Redis 使用 Raft 算法实现领导者选举，Raft 算法比较复杂，大致思路如下：

1. 每个做出主观下线的 Sentinel 节点向其他 Sentinel 节点请求成为领导者节点
2. 收到请求的 Sentinel 节点如果还未投票，则投票同意请求者成为领导者节点
3. 如果某一个 Sentinel 节点发现自己获得了超过规定的票数，则成为领导者
4. 如果此过程没有人成为领导者，则发起下一轮投票

#### 故障转移

领导者 Sentinel 节点负责故障转移，步骤如下：

1. 在从节点中选择一个节点作为新的主节点，选择方法如下：a) 过滤掉不健康的节点。 b) 选择优先级最高的节点，如果存在则返回，否则继续。 c) 选择复制偏移量最大的节点，如果存在则返回，否则继续。 d) 选择 runID 最小的节点。

2. 领导者节点会对第一步筛选出来的节点执行 ```slaveof no one``` 使其成为主节点。

3. 领导者节点向其他从节点发送命令，使其成为新主节点的从节点。

4. Sentinel 节点集合将旧主节点更新为为从节点，对其保持关注，等它恢复后命令它复制新的主节点。


### 客户端使用

主流的 Redis 客户端都对 Sentinel 提供了支持，我们使用这些客户端时，不必再提供主节点的地址，而是提供 Sentinel 节点的地址，客户端会从 Sentinel 节点获取主节点的信息。整个过程大致如下：

1. 客户端遍历 Sentinel 节点集合，找到一个可用的节点
2. 从 Sentinel 节点获取主节点的地址和端口
3. 初始化连接池
4. 订阅 Sentinel 节点切换主节点的频道 ```+switch-master```
5. 监听到主节点切换后，重新初始化连接池

### 使用 Sentinel 注意事项

- Sentinel 节点不应部署在同一台物理机上
- 部署至少三个且奇数个 Sentinel 节点，

