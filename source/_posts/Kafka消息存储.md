---
title: Kafka消息存储
categories:
  - Kafka
tags:
  - Kafka
date: 2019-04-13 16:30:05
---

在 Kafka 中消息存储在磁盘上，那么消息在服务器上是怎么存储的呢？<!-- more -->


### 存储位置

在 Kafka 中消息存储的位置由参数 ```log.dirs``` 指定，它是一组用逗号分隔的本地文件系统路径，如果指定了多个路径，那么 broker 上不同分区的数据会均匀分布在多个路径下，注意同一个分区的数据只会分布在一个路径下。

当 broker 上新增一个分区时，broker 会把这个分区分配到含有最少分区的路径下，而不是分配到有最大剩余磁盘空间的路径下。

```log.dirs``` 并没有默认值，如果 ```log.dirs``` 没有设置，那么 Kafka 会使用另一个配置 ```log.dir```，而 ```log.dir```是有默认值的，它的默认值是 ```/tmp/kafka-logs```。

### 文件目录布局

简单起见，我们假设只有一个 broker，存储位置使用默认值 ```/tmp/kafka-logs```，如果我们创建一个名为 ```my-topic``` 的主题，分区数为 3，复制系数为 1，那么在 ```/tmp/kafka-logs``` 下就会新增 3 个文件夹 ```my-topic-0```、```my-topic-1```、```my-topic-2```，分别存储 ```my-topic``` 主题下 3 个分区的数据，严格来说，每个文件夹下存储的是某个分区其中一个副本的数据。

每个文件夹下会有多种文件，其中最重要的文件就是日志文件和索引文件，日志文件以 ```.log``` 为后缀，索引文件有两种，一种是偏移量索引文件（以 ```.index``` 为后缀），另一种是时间戳索引文件（以 ```.timeindex``` 为后缀）。

### 日志分段

为了防止日志文件过大，Kafka 又引入了日志分段（LogSegment），每个日志片段只存储一部分消息，这样可以防止一个日志文件过大，另外也方便删除过期的消息。

在 Kafka 中消息是顺序写入日志文件的，只有最后一个 LogSegment 执行写入操作，之前的所有 LogSegment 只能读取。我们将最后一个 LogSegment 称为 ActiveSegment，当满足一定条件时，Kafka 会将 ActiveSegment 关闭，将其设置为只读，然后新建一个新的 ActiveSegment，之后追加的消息都将写入新的 ActiveSegment。

日志分段文件和索引分段文件是一一对应的，当日志文件分段时索引文件也需要对应分段。当满足以下几种情况中的任意一种时，Kafka 会新建一个 LogSegment：

- 当前 LogSegment 大小超过了指定值（默认 1G）
- 当前 LogSegment 中消息的最大时间戳与系统时间戳的差值大于指定值（默认 7 天）
- 偏移量索引文件或者时间戳索引文件的大小超过了指定值（默认 10M）
- 当前 LogSegment 中消息个数超过 ```Integer.MAX_VALUE```

每个 LogSegment 都会有一个基准偏移量 baseOffset，用来表示当前 LogSegment 中第一条消息的偏移量。偏移量是一个 64 位的长整型，日志文件和索引文件都是根据 baseOffset 来命名的，名称固定为 20 位数字，不足的用 0 填充，比如一个 LogSegment 的 baseOffset = 123，那么对应的日志文件为 ```00000000000000000123.log```，两个索引文件为 ```00000000000000000123.index``` 和 ```00000000000000000123.timeindex```。


### 日志文件

### 索引文件

Kafka 中索引文件是以稀松索引的方式构造消息的索引，它并不保证每条消息都在索引文件中有对应的索引项，而是每当写入一定量（默认 4KB）的消息时才新增一条索引项。


#### 偏移量索引

偏移量索引文件中每个索引项占 8 个字节，分为两个部分：

- relativeOffset：相对偏移量，表示消息相对 baseOffset 的偏移量，占 4 个字节。正是因为 relativeOffset 占 4 个字节，所以一个 LogSegment 中消息个数不能超过 ```Integer.MAX_VALUE```。
- position：物理地址，表示这条消息在 LogSegment 中的物理地址，占 4 个字节。


#### 时间戳索引

时间戳索引是根据时间戳索引到对应的相对偏移量而不是实际的物理地址，每个索引项占 12 个字节，分为两个部分：

- timestamp：时间戳，占 8 个字节。
- relativeOffset：相对偏移量，占 4 个字节。





