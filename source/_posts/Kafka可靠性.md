---
title: Kafka可靠性
categories:
  - Kafka
tags:
  - Kafka
date: 2019-04-07 17:47:46
---

kafka 在数据传递可靠性方面具备很大的灵活性，有些场景需要很高的可靠性，而另一些场景则更看重速度和简便性，本篇文章就来介绍下 kafka 怎么保证可靠性。<!-- more -->

## Kafka 服务器

kafka 的复制机制和分区的多副本架构是 kafka 可靠性保证的核心，把消息写入多个副本可以使 kafka 在发生崩溃时仍能保证消息的持久性。

### 复制系数

复制系数表示一个分区一共有多少个副本，我们可以对主题设置复制系数 ```replication.factor```，如果不设置的话，则主题使用 broker 的默认复制系数 ```default.replication.factor```。

如果复制系数是 N，那么在 N-1 个 broker 失效的情况下，客户端仍然可以向主题写入数据或者从主题读取数据。所以，更高的复制系数会带来更高的可用性和可靠性。但是另一方面，复制系数 N 表示至少需要 N 个 broker，占据 N 倍的磁盘空间。因此我们需要在可用性和存储硬件间做出权衡。

一般情况下，我们建议把复制系数设为 3，在大多数情况下，它已经足够安全了。

### 首领副本

一个分区可能有多个副本，这取决于复制系数，副本有以下两种类型：

- 首领副本：每个分区都有一个首领副本，为了保证一致性，所有生产者请求和消费者请求都会经过这个副本。
- 跟随者副本：首领副本以外的副本都是跟随者副本，跟随者副本不处理来自客户端的请求，它们唯一的任务就是从首领副本那里复制消息，保持与首领一致的状态。如果首领发生崩溃，其中的一个跟随者就会被选举为新首领。

当首领崩溃时，并不是所有的跟随者副本都有资格被选为新首领，只有同步的副本才有资格。对于跟随者副本来说，它需要满足以下条件时才会被认为是同步的：

- 与 Zookeeper 之间有一个活跃的会话
- 在过去的 10s 内从首领副本获取过消息
- 在过去的 10s 内从首领副本获取过最新的消息

一个非同步的副本可以通过满足以上所有条件重新变成同步的副本。

### 首领选举

当首领副本崩溃后，需要从同步的副本中选举出一个新首领，而新首领的选举是在控制器的操作下进行的。

控制器其实就是一个 broker，当控制器崩溃时，其他的 broker 会收到通知，然后从剩余的 broker 中重新选举出一个控制器。

当控制器发现一个 broker 离开集群，那么首领副本在这个 broker 上的分区就需要重新选举出新的首领副本，控制器会遍历这些分区，并确定谁应该成为新首领（简单来说就是分区副本列表里的下一个副本成为新首领），然后通知其他的 broker。随后，新首领开始处理客户端的请求，跟随者副本开始从新首领复制消息。

当控制器发现一个 broker 加入集群，他会使用 broker Id 检查新加入的 broker 是否包含现有分区的副本，如果有，控制器会通知其他的 broker，新 broker 上的副本开始从首领那里复制消息。

### 不完全的首领选举

当分区首领不可用时，一个同步副本会被选为新首领。如果在选举过程中没有丢失数据，那么这个选举就是完全的；但是如果首领不可用时，其他副本都是不同步的，如果允许进行首领选举，那么这个选举就是不完全的首领选举。

如果我们允许不同步的副本成为首领，那么就要承担丢失数据和出现数据不一致的风险；如果不允许它们成为首领，那么就要接受较低的可用性，因为我们必须等待原先的首领恢复到可用状态。

### 最少同步副本

虽然一个分区可以有多个副本，但是也会出现只有一个同步副本的情况，就是除了首领副本外，其他副本都不是同步的副本，如果这时首领副本发生故障，我们不得不在可用性和一致性之间做出选择。

为了避免这种情况，我们可以通过 ```min.insync.replicas``` 设置最少同步副本，比如我们可以把这个参数设置为 2，这样就能保证至少有两个副本是同步的才能向分区写入消息。这样做虽然有助于提高可靠性，但是也牺牲了可用性，当同步副本数过少时，那么 broker 就会停止接收生产者的请求。

## 生产者

### 发送确认

生产者可以通过发送确认来保证发送的消息已经被服务器接收。

### 设置生产者重试

通过设置生产者重试可以让生产者客户端在碰到可重试错误时自动重试。

### 错误处理

通过设置重试可以让客户端处理大部分错误，但是有些错误不能通过重试解决，这需要生产者主动处理这些错误，比如将发送失败的消息记录到日志或数据库，过段时间再重试。


## 消费者

为了防止消费者丢失消息，消费者应该始终在消费完消息后再提交偏移量。


