---
title: RabbitMQ高级队列
categories:
  - RabbitMQ
tags:
  - RabbitMQ
date: 2019-03-24 13:55:20
---

在 RabbitMQ 中除了使用普通队列外，我们还可以利用 TTL 特性构造一些高级队列，比如死信队列、延迟队列、优先级队列等，这些队列在一些场景中非常有用。<!-- more -->

## TTL

TTL，Time To Live，即过期时间。目前有两种方式可以设置消息的 TTL:

- 通过队列属性设置，队列中所有消息都有相同的过期时间
- 对消息本身进行单独设置

如果这两种方式一起使用，则以较小的 TTL 为准。消息在队列中的生存时间一旦超过设置的 TTL 时，就会变成死信。

RabbitMQ 是在投递消息时再判断是否过期，所以对于第一种方式，过期的消息一定会在队列头部，而对于第二种方式，则不一定。

## 死信队列

当消息在一个队列中变成死信后，它能被重新发送到另一个交换器中，这个交换器就是死信交换器（Dead Letter Exchange，DLX），而绑定 DLX 的队列就称之为死信队列。

消息变成死信一般是因为以下几种情况：

- 消息被拒绝，并且设置 requeue 参数为 false。
- 消息过期
- 队列达到最大长度


## 延迟队列

延迟队列存储的对象是对应的延迟消息，所谓的延迟消息是指当消息被发送以后，并不想让消费者立即拿到消息，而是等待特定时间后，消费者才能拿到这个消息进行消费。

延迟队列应用的场景很多，比如：

- 订单下单之后30分钟后，如果用户没有付钱，则系统自动取消订单。
- 定时任务可以放在延时队列中，到达指定时间再进行执行。

RabbitMQ 本身并没有直接支持延时队列，但是可以通过 DLX 和 TTL 来模拟出延时队列的功能。比如我们可以设置队列的 TTL 为 10 分钟，并为队列设置 DLX，那么消费者不去消费真正的队列而是消费死信队列，这样就模拟出了延时 10 分钟的效果。

## 优先级队列

优先级队列是指队列中的消息具有优先级，优先级高的消息具有优先被消费的特权。
