---
title: Redis复制
categories:
  - Redis
tags:
  - Redis
date: 2019-03-10 13:47:32
---

复制功能是 Redis 高可用的基础，实现了相同数据的多个 Redis 副本，满足故障恢复和负载均衡等需求。<!-- more -->

## 使用复制

参与复制的 Redis 实例划分为主节点（master）和从节点（slave），每个从节点都只能有一个主节点，而主节点可以同时具有多个从节点。

### 建立复制

建立复制的方式有以下三种：

- 在配置文件加入 ```slaveof {masterHost} {masterPort}```，随 Redis 启动生效

- 在 ```redis-server``` 命令后加入 ```--slaveof {masterHost} {masterPort}``` 参数

- 直接使用命令 ```slaveof {masterHost} {masterPort}```


### 断开复制

在从节点执行 ```slaveof no one``` 来断开与主节点的复制关系，断开复制后，从节点的数据并不会删除。

### 切换主节点

切换主节点就是先断开旧节点的复制关系，然后再关联新节点，整个流程如下：

1. 断开与旧主节点复制关系
2. 与新主节点建立复制关系
3. 删除从节点当前所有数据
4. 对新主节点进行复制操作


## 拓扑结构

Redis 的复制拓扑结构可以支持单层或多层复制关系，根据拓扑复杂性可以分为以下三种：

### 一主一从

一主一从是最简单的复制拓扑结构，用于主节点出现宕机时从节点提供故障专一支持。

当应用写命令并发较高且需要持久化时，可以只在从节点开启 AOF。但是注意，主节点脱机后要避免自动重启操作。

### 一主多从

一主多从结构使得应用端可以利用多个从节点实现读写分离，但是多个从节点会导致主节点写命令的多次发送而过度消耗网络带宽，同时也加重了主节点的负载影响服务的稳定性。

### 树状主从结构

树状主从结构使得从节点不但可以从主节点复制数据，也可以从其他从节点复制数据。通过引入中间层，可以有效降低主节点的负载。


## 复制过程

在从节点执行 slaveof 命令后，复制过程变开始运作，整个过程大致分为六个过程：

1. 保存主节点信息（地址和端口）
2. 从节点内部通过每秒运行定时任务来维护复制相关逻辑，当定时任务发现存在新的主节点后，会尝试与该节点建立网络连接。
3. 发送 ping 命令，主要是检测主从之间 socket 是否可用、检测主节点当前是否接受处理命令。
4. 权限验证
5. 同步数据集，使用复制命令 psync 进行数据同步，这部分操作耗时最长。数据同步分为全量同步和部分同步。
6. 命令持续复制，当主节点把当前数据同步给从节点后，主节点会持续地把写命令发送给从节点，保证主从数据的一致性。


### psync 命令

从节点使用 psync 命令完成部分复制和全量复制，命令格式 ```psync {runID} {offset}```，参数含义如下：

- runID : 主节点的运行 ID
  - 每个 Redis 节点启动后都会动态分配一个 40 位的十六进制字符串作为运行 ID，当主节点运行 ID 变化后，从节点会进行全量复制。
  - Redis 关闭再重启后，运行 ID 会发生变化。
  - 可以使用 debug reload 命令重启 Redis 并保持运行 ID 不变。
  - debug reload 命令会阻塞 Redis 主线程，然后生成 RDB 文件并清空数据后再加载 RDB 文件。

- offset : 复制偏移量
  - 参与复制的主从节点都会维护自身的复制偏移量。
  - 通过对比主从节点的复制偏移量可以判断主从节点是否一致。

### 复制积压缓冲区

复制积压缓冲区是保存在主节点上的一个固定长度的队列，默认大小为 1M，当主节点有连接的从节点时被创建，这时主节点响应写命令时，会把命令写入复制积压缓冲区，然后异步同步给从节点。

复制积压缓冲区本质上是先进先出的定长环形队列，如果队列内容满了，就会从头开始覆盖前面的内容，所以复制积压缓冲区会保存最近已复制数据的功能。

### 全量复制

全量复制是把数据全量同步给从节点，触发全量复制的情况有两种：

- 第一次建立复制时

- 主从复制断开重连后，复制偏移量对应的数据已经不在复制积压缓冲区中

全量复制的流程大致如下:

1. 发送 psync 命令进行数据同步，如果是第一次进行复制，从节点没有主节点运行 ID，所以发送 ```psync ? -1```。
2. 主节点发现需要全量复制，回复 +FULLRESYNC 响应。
3. 从节点接收主节点响应数据，保存主节点运行 ID 和偏移量 offset。
4. 主节点执行 bgsave 保存 RDB 文件到本地。
5. 主节点发送 RDB 文件给从节点。
6. 发送完 RDB 文件期间，主节点会把写命令写入到复制客户端缓冲区，RDB 文件发送结束后，再把复制客户端缓冲区数据发送给从节点。
7. 从节点接收完主节点传来的全部数据后会清空自身旧数据。
8. 加载 RDB 文件。
9. 从节点加载完 RDB 文件后，如果开启了 AOF 持久化功能，则会立即执行 bgrewriteaof 操作。

全量复制过程中会进行多次持久化相关操作和网络数据传输，这期间会大量消耗主从节点所在服务器的 CPU、内存和网络资源，所以除了第一次复制时必须采用全量复制外，其他情况都应该避免全量复制的发生。


### 部分复制

部分复制是对全量复制的优化，当主从复制出现网络闪断或者命令丢失等意外情况时，从节点发送```psync {runID} {offset}```命令要求补发数据，如果偏移量在复制积压缓冲区内，则直接发送给从节点。由于补发数据一般远小于全量数据，所以开销很小。

部分复制流程大致如下：

1. 主从复制网络出现中断，主从节点网络恢复后，发送```psync {runID} {offset}```命令要求补发数据。

2. 主节点接收到 psync 命令后，首先比对 runID 是否与自身一致，如果一致，则根据 offset 到复制积压缓冲区查找，如果数据在缓冲区内，则对节点发送 +CONTINUE 响应，表示可以进行部分复制；否则回复 +FULLRESYNC 响应，表示全量复制。

3. 主节点根据偏移量把复制积压缓冲区内数据发送给从节点，保证主从复制进入正常状态。


## 使用复制功能时需要避免的坑

### 主从配置不一致

主从配置不一致是一个容易忽略的问题，对于有些配置可以不一致，比如主节点关闭 AOF，而从节点开启；但是对于内存相关的配置必须要一致。

### 规避全量复制

- 第一次建立复制，这种情况全量复制无法避免，当对数据量较大且流量较高的主节点添加从节点时，建议在低峰时进行操作，或者尽量避免大数据量的 Redis 节点。

- 节点运行 ID 不匹配，主节点因故障重启后，它的运行 ID 会改变，从节点发现主节点运行 ID 变化时，会进行全量同步。对于这种情况应从架构上规避，比如提供故障转移功能。

- 复制积压缓冲区不足，主从节点闪断后重连，如果复制积压缓冲区过小，可能会导致从节点全量复制。对于大流量的 Redis 节点应合理规划复制积压缓冲区。

### 规避复制风暴

#### 单节点复制风暴

单节点复制风暴是指多个从节点同时对一个主节点发起全量复制，导致主节点网络带宽消耗严重，解决方案就是减少主节点挂载从节点的数量，加入中间层从节点来保护主节点。

#### 单机器复制风暴

当一台机器上同时部署多个主节点时，如果这台机器出现故障或网络中断，当它重启恢复后，会有大量从节点对这台机器上的主节点进行全量复制。

解决方案是：避免单台机器上部署过多主节点，另外提供故障转移机制。




